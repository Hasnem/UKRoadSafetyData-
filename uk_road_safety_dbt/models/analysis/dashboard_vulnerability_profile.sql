-- ════════════════════════════════════════════════════════════════
-- Vulnerability Profile: Fatality Rate by Road User + Age
-- Tableau: profile_label → Rows (sort by sort_order),
--          fatality_rate_pct → Columns, bar_color_hex → Color
-- ════════════════════════════════════════════════════════════════

with profiles as (

    -- 1. Pedestrian Over 75 (highest fatality rate)
    select
        'Pedestrian · Over 75' as profile_label,
        1 as sort_order,
        count(*) as total_casualties,
        sum(case when casualty_severity = 'Fatal' then 1 else 0 end)
                                                                    as total_fatalities
    from {{ ref('mart_casualties') }}
    where casualty_type = 'Pedestrian'
      and age_band_of_casualty = 'Over 75'

    union all

    -- 2. Motorcycle 500cc+
    select 'Motorcycle 500cc+', 2, count(*),
        sum(case when casualty_severity = 'Fatal' then 1 else 0 end)
    from {{ ref('mart_casualties') }}
    where casualty_type = 'Motorcycle over 500cc'

    union all

    -- 3. Pedestrian 66-75
    select 'Pedestrian · 66-75', 3, count(*),
        sum(case when casualty_severity = 'Fatal' then 1 else 0 end)
    from {{ ref('mart_casualties') }}
    where casualty_type = 'Pedestrian'
      and age_band_of_casualty = '66 - 75'

    union all

    -- 4. Motorcycle 125-500cc
    select 'Motorcycle 125-500cc', 4, count(*),
        sum(case when casualty_severity = 'Fatal' then 1 else 0 end)
    from {{ ref('mart_casualties') }}
    where casualty_type = 'Motorcycle over 125cc and up to 500cc'

    union all

    -- 5. Cyclist (all ages)
    select 'Cyclist (all ages)', 5, count(*),
        sum(case when casualty_severity = 'Fatal' then 1 else 0 end)
    from {{ ref('mart_casualties') }}
    where casualty_type = 'Cyclist'

    union all

    -- 6. All Casualties Average (reference line)
    select 'All Casualties (Average)', 6, count(*),
        sum(case when casualty_severity = 'Fatal' then 1 else 0 end)
    from {{ ref('mart_casualties') }}

    union all

    -- 7. Car Occupant (all ages)
    select 'Car Occupant (all ages)', 7, count(*),
        sum(case when casualty_severity = 'Fatal' then 1 else 0 end)
    from {{ ref('mart_casualties') }}
    where casualty_type = 'Car occupant'

    union all

    -- 8. Pedestrian Child (0-15)
    select 'Pedestrian · Child (0-15)', 8, count(*),
        sum(case when casualty_severity = 'Fatal' then 1 else 0 end)
    from {{ ref('mart_casualties') }}
    where casualty_type = 'Pedestrian'
      and age_band_of_casualty in ('0 - 5', '6 - 10', '11 - 15')

),

with_rates as (

    select
        profile_label,
        sort_order,
        total_casualties,
        total_fatalities,
        round(total_fatalities::float
              / nullif(total_casualties, 0) * 100, 2)              as fatality_rate_pct
    from profiles

),

avg_rate as (

    select fatality_rate_pct as overall_avg_rate
    from with_rates
    where profile_label = 'All Casualties (Average)'

)

select
    w.profile_label,
    w.sort_order,
    w.total_casualties,
    w.total_fatalities,
    w.fatality_rate_pct,
    a.overall_avg_rate,
    round(w.fatality_rate_pct
          / nullif(a.overall_avg_rate, 0), 1)                       as multiplier_vs_avg,

    -- ── Bar color (severity scale) ────────────────────────────
    case
        when w.fatality_rate_pct >= 5.0 then '#B81D13'
        when w.fatality_rate_pct >= 3.0 then '#EF7D00'
        when w.fatality_rate_pct >= 1.5 then '#FFB020'
        when w.fatality_rate_pct >= 0.8 then '#A6A6A6'
        else '#008450'
    end                                                             as bar_color_hex,

    -- ── Comparison to average ─────────────────────────────────
    case
        when w.fatality_rate_pct > a.overall_avg_rate then 'Above Average'
        else 'Below Average'
    end                                                             as vs_average,

    -- ── Reference line flag ───────────────────────────────────
    case when w.profile_label = 'All Casualties (Average)'
         then true else false
    end                                                             as is_reference_line,

    -- ── Pre-formatted labels ──────────────────────────────────
    w.fatality_rate_pct::varchar || '%'                              as rate_label,
    round(w.fatality_rate_pct
          / nullif(a.overall_avg_rate, 0), 1)::varchar || 'x avg'   as multiplier_label,

    -- ── Tooltip ───────────────────────────────────────────────
    w.profile_label
        || ' | Fatality Rate: ' || w.fatality_rate_pct::varchar || '%'
        || ' (' || round(w.fatality_rate_pct
                         / nullif(a.overall_avg_rate, 0), 1)::varchar
        || 'x average)'
        || ' | Casualties: ' || w.total_casualties::varchar
        || ' | Fatalities: ' || w.total_fatalities::varchar         as tooltip_text

from with_rates w
cross join avg_rate a
order by w.fatality_rate_pct desc
